var https = require('https');
var url = require('url');
var fs = require('fs');
var io = require('socket.io');
var context = require('rabbit.js').createContext(
    'amqp://producer:PrOdUcInG@producer-dev.mit.edu:5672/producer' // URL
);

var port = process.argv[2] || 8888;

var privateKey = fs.readFileSync('/etc/httpd/conf/ssl.key/producer-dev.mit.edu.key').toString();
var certificate = fs.readFileSync('/etc/httpd/conf/ssl.crt/producer-dev.mit.edu.crt').toString();
var ca = fs.readFileSync('/etc/httpd/conf/ssl.ca/InCommon-chain.crt').toString();

var httpsserver = https.createServer({
        key: privateKey,
        cert: certificate,
        ca: ca
    },
    handler);

var socketioserver = io.listen(httpsserver, {
        key: privateKey,
        cert: certificate,
        ca: ca
    });

socketioserver.sockets.on('connection', function(connection) {
  var sub = context.socket('SUB');

  connection.on('disconnect', function() {
    sub.close();
  });

  // NB we have to adapt between the APIs
  sub.setEncoding('utf8');
  sub.on('data', function(msg) {
    connection.send(msg);
  });
  sub.connect('backstage.producer');
});

httpsserver.listen(port, '0.0.0.0');

// ==== boring detail

function handler(req, res) {
  var path = url.parse(req.url).pathname;
  switch (path){
  case '/':
    path = '/index.html';
  case '/index.html':
    fs.readFile(__dirname + '/index.html', function(err, data){
      if (err) return send404(res);
      res.writeHead(200, {'Content-Type': 'text/html'});
      res.write(data, 'utf8');
      res.end();
    });
    break;
  default: send404(res);
  }
}

function send404(res){
  res.writeHead(404);
  res.write('404');
  res.end();
}

